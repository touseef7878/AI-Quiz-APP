{% extends "base.html" %}

{% block title %}Take Quiz: {{ quiz.topic }} - AI Quiz App{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Quiz Header -->
        <div class="card border-0 shadow-lg fade-in-up mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">{{ quiz.topic }}</h2>
                        <span class="badge bg-{{ 'success' if quiz.difficulty == 'simple' else 'warning' if quiz.difficulty == 'medium' else 'danger' }} fs-6">
                            {{ quiz.difficulty.title() }} Level
                        </span>
                    </div>
                    <div class="text-end">
                        <div class="h4 mb-0" id="timer">00:00</div>
                        <small class="text-muted">Time Elapsed</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="card border-0 shadow-lg fade-in-up mb-4">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">Progress</span>
                    <span id="progressText">0 / {{ questions|length }}</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Quiz Form -->
        <form id="quizForm">
            {% for question in questions %}
            <div class="card border-0 shadow-lg fade-in-up mb-4 question-card" data-question-id="{{ question.id }}">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <span class="badge bg-primary me-3 fs-6">{{ question.question_number }}</span>
                        <h5 class="mb-0">{{ question.question_text }}</h5>
                    </div>
                    
                    <div class="options-container">
                        {% for option_key, option_text in question.options.items() %}
                        <div class="form-check mb-2 option-item">
                            <input class="form-check-input" type="radio" 
                                   name="question_{{ question.id }}" 
                                   id="q{{ question.id }}_{{ option_key }}" 
                                   value="{{ option_key }}"
                                   data-question-id="{{ question.id }}">
                            <label class="form-check-label w-100" for="q{{ question.id }}_{{ option_key }}">
                                <strong>{{ option_key }}.</strong> {{ option_text }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Submit Button -->
            <div class="card border-0 shadow-lg fade-in-up">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">Submit Quiz</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let startTime = Date.now();
let answeredQuestions = new Set();
let totalQuestions = {{ questions|length }};
let submitBtn;

document.addEventListener('DOMContentLoaded', function() {
    submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true; // Initially disable the button

    // Start timer
    updateTimer();
    setInterval(updateTimer, 1000);
    
    // Handle option selection
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionId = this.dataset.questionId;
            answeredQuestions.add(questionId);
            updateProgress();
            
            // Visual feedback for selected option
            const questionCard = this.closest('.question-card');
            questionCard.classList.add('answered');
        });
    });
    
    // Handle form submission
    document.getElementById('quizForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (answeredQuestions.size < totalQuestions) {
            alert('Please answer all questions before submitting.');
            return;
        }
        
        submitQuiz();
    });
});

function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateProgress() {
    const progress = (answeredQuestions.size / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${answeredQuestions.size} / ${totalQuestions}`;
    
    if (answeredQuestions.size === totalQuestions) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
}

async function submitQuiz() {
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
    submitBtn.disabled = true;
    
    // Collect answers
    const answers = {};
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const questionId = radio.dataset.questionId;
        answers[questionId] = radio.value;
    });
    
    try {
        const response = await fetch(`/quiz/api/quiz/{{ quiz.id }}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ answers: answers })
        });
        
        const data = await response.json();
        
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
        } else {
            // Fallback if no redirect URL, though backend should provide one
            alert(data.message || 'Quiz submitted, but no redirect URL provided.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error submitting quiz:', error);
        alert('Failed to submit quiz. Please try again.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}
</script>
{% endblock %}
